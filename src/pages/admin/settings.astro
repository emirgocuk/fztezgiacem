---
import AdminLayout from "../../layouts/AdminLayout.astro";
---

<AdminLayout title="Ayarlar">
  <div class="max-w-4xl mx-auto">
    <h1 class="text-2xl font-bold mb-6">Ayarlar</h1>

    <div class="bg-white p-8 rounded-xl shadow-sm border border-gray-100">
      <h2 class="text-lg font-semibold mb-4 border-b pb-2">
        Geliştirici Seçenekleri
      </h2>

      <div class="flex items-center justify-between py-4">
        <div>
          <h3 class="font-medium text-gray-900">Test Verisi Oluşturucu</h3>
          <p class="text-sm text-gray-500">
            Yazı editöründe "Test Verisi Doldur" butonunu göster.
          </p>
        </div>
        <label class="relative inline-flex items-center cursor-pointer">
          <input type="checkbox" id="devModeToggle" class="sr-only peer" />
          <div
            class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-green-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-[#1E3A1A]"
          >
          </div>
        </label>
      </div>
    </div>

    <div class="bg-white p-8 rounded-xl shadow-sm border border-gray-100 mt-8">
      <h2 class="text-lg font-semibold mb-4 border-b pb-2">
        İletişim Ayarları
      </h2>

      <div class="py-4">
        <label
          for="contactEmail"
          class="block text-sm font-medium text-gray-700 mb-1"
          >Bildirim E-postası</label
        >
        <p class="text-sm text-gray-500 mb-2">
          İletişim formundan gelen mesajlar bu adrese bildirilsin.
        </p>
        <div class="flex flex-col md:flex-row gap-4">
          <input
            type="email"
            id="contactEmail"
            class="w-full md:flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#1E3A1A] focus:border-transparent outline-none transition"
            placeholder="ornek@email.com"
          />
          <button
            id="saveEmailBtn"
            class="w-full md:w-auto bg-[#1E3A1A] text-white px-6 py-2 rounded-lg font-medium hover:bg-[#1E3A1A]/90 transition"
            >Kaydet</button
          >
        </div>
        <p id="emailStatus" class="mt-2 text-sm"></p>
      </div>
    </div>
  </div>

  <script>
    import { pb } from "../../lib/pocketbase";

    // Handle Dev Mode Toggle
    const toggle = document.getElementById("devModeToggle") as HTMLInputElement;
    const isDevMode = localStorage.getItem("devMode") === "true";
    if (toggle) toggle.checked = isDevMode;

    toggle?.addEventListener("change", (e) => {
      const checked = (e.target as HTMLInputElement).checked;
      localStorage.setItem("devMode", checked.toString());
      alert(
        checked
          ? "Geliştirici modu AÇIK. Editörde test butonu görünecek."
          : "Geliştirici modu KAPALI.",
      );
    });

    // Handle Notification Email
    const emailInput = document.getElementById(
      "contactEmail",
    ) as HTMLInputElement;
    const saveBtn = document.getElementById("saveEmailBtn");
    const emailStatus = document.getElementById("emailStatus");
    let settingId = "";

    // Load existing setting
    async function loadSettings() {
      try {
        const records = await pb.collection("site_settings").getList(1, 1);
        if (records.items.length > 0) {
          const setting = records.items[0];
          settingId = setting.id;
          if (emailInput) emailInput.value = setting.contact_email || "";
        }
      } catch (err) {
        console.error("Error loading settings:", err);
      }
    }

    loadSettings();

    // Save setting
    saveBtn?.addEventListener("click", async () => {
      const email = emailInput?.value;
      if (!email) return;

      if (emailStatus) {
        emailStatus.textContent = "Kaydediliyor...";
        emailStatus.className = "mt-2 text-sm text-gray-500";
      }

      try {
        if (settingId) {
          await pb
            .collection("site_settings")
            .update(settingId, { contact_email: email });
        } else {
          const record = await pb
            .collection("site_settings")
            .create({ contact_email: email });
          settingId = record.id;
        }

        if (emailStatus) {
          emailStatus.textContent = "Başarıyla kaydedildi.";
          emailStatus.className = "mt-2 text-sm text-green-600 font-medium";
          setTimeout(() => {
            if (emailStatus) emailStatus.textContent = "";
          }, 3000);
        }
      } catch (err: any) {
        console.error("Error saving settings:", err);
        if (emailStatus) {
          emailStatus.textContent = "Hata: " + err.message;
          emailStatus.className = "mt-2 text-sm text-red-600";
        }
      }
    });
  </script>
</AdminLayout>
