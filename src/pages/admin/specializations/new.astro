---
import AdminLayout from "../../../layouts/AdminLayout.astro";

// Client-side logic handles form submission
---

<AdminLayout title="Yeni Uzmanl覺k Alan覺 Ekle">
    <div class="max-w-2xl mx-auto">
        <h1 class="text-3xl font-bold mb-8">Yeni Uzmanl覺k Alan覺</h1>

        <form
            id="createForm"
            class="bg-white p-8 rounded-xl shadow-sm space-y-6"
        >
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1"
                    >Bal覺k</label
                >
                <input
                    type="text"
                    name="title"
                    required
                    class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-[#1E3A1A] outline-none"
                />
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1"
                    >Slug (URL K覺sm覺 - 繹rn: otizm-tedavisi)</label
                >
                <input
                    type="text"
                    name="slug"
                    required
                    class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-[#1E3A1A] outline-none"
                />
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1"
                        >襤kon (Emoji)</label
                    >
                    <input
                        type="text"
                        name="icon"
                        placeholder="妝"
                        class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-[#1E3A1A] outline-none"
                    />
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1"
                        >Renk Temas覺</label
                    >
                    <select
                        name="color"
                        class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-[#1E3A1A] outline-none bg-white"
                    >
                        <option value="orange">Turuncu</option>
                        <option value="yellow">Sar覺</option>
                        <option value="blue">Mavi</option>
                        <option value="green">Yeil</option>
                        <option value="purple">Mor</option>
                    </select>
                </div>
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1"
                    >G繹rsel Y羹kle</label
                >
                <div class="flex items-center gap-4">
                    <img
                        id="previewImage"
                        src=""
                        class="w-16 h-16 object-cover rounded-lg hidden border"
                    />
                    <label
                        class="cursor-pointer bg-white border border-gray-300 hover:bg-gray-50 px-4 py-2 rounded-lg text-sm font-medium text-gray-700 transition"
                    >
                        <span>Resim Se癟</span>
                        <input
                            type="file"
                            id="fileInput"
                            accept="image/*"
                            class="hidden"
                        />
                    </label>
                    <span id="fileName" class="text-sm text-gray-500"
                        >Dosya se癟ilmedi</span
                    >
                </div>
                <input type="hidden" name="image" id="imageUrl" required />
                <p id="uploadStatus" class="text-xs text-gray-500 mt-1">
                    L羹tfen bir g繹rsel se癟in.
                </p>
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1"
                    >zet (Listeleme Ekran覺 襤癟in)</label
                >
                <textarea
                    name="summary"
                    rows="2"
                    class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-[#1E3A1A] outline-none"
                ></textarea>
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1"
                    >Detayl覺 襤癟erik</label
                >
                <textarea
                    name="details"
                    rows="6"
                    class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-[#1E3A1A] outline-none"
                ></textarea>
            </div>

            <div class="pt-4 flex justify-end gap-3">
                <a
                    href="/admin/specializations"
                    class="px-6 py-2 border rounded-lg hover:bg-gray-50 transition"
                    >襤ptal</a
                >
                <button
                    type="submit"
                    class="bg-[#1E3A1A] text-white px-6 py-2 rounded-lg hover:bg-[#1E3A1A]/90 transition"
                    >Kaydet</button
                >
            </div>
        </form>
    </div>

    <script>
        import { pb } from "../../../lib/pocketbase";
        import { uploadToImgBB } from "../../../lib/imgbb";

        const form = document.getElementById("createForm") as HTMLFormElement;
        const fileInput = document.getElementById(
            "fileInput",
        ) as HTMLInputElement;
        const imageUrl = document.getElementById(
            "imageUrl",
        ) as HTMLInputElement;
        const previewImage = document.getElementById(
            "previewImage",
        ) as HTMLImageElement;
        const fileName = document.getElementById("fileName");
        const uploadStatus = document.getElementById("uploadStatus");

        fileInput?.addEventListener("change", async () => {
            const file = fileInput.files?.[0];
            if (!file) return;

            fileName!.textContent = file.name;
            uploadStatus!.textContent = "Y羹kleniyor...";
            uploadStatus!.className = "text-xs text-blue-500 mt-1 font-medium";

            try {
                const url = await uploadToImgBB(file);
                imageUrl.value = url;

                previewImage.src = url;
                previewImage.classList.remove("hidden");

                uploadStatus!.textContent = "Resim baar覺yla y羹klendi.";
                uploadStatus!.className =
                    "text-xs text-green-600 mt-1 font-medium";
            } catch (err) {
                console.error(err);
                uploadStatus!.textContent = "Hata: " + (err as Error).message;
                uploadStatus!.className =
                    "text-xs text-red-500 mt-1 font-medium";
                imageUrl.value = ""; // Reset on failure
            }
        });

        form?.addEventListener("submit", async (e) => {
            e.preventDefault();
            const formData = new FormData(form);
            const data = Object.fromEntries(formData);

            if (!data.image) {
                alert("L羹tfen bir resim y羹kleyiniz.");
                return;
            }

            try {
                await pb.collection("specializations").create(data);
                window.location.href = "/admin/specializations";
            } catch (err: any) {
                console.error(err);
                alert("Hata olutu: " + (err.message || "Bilinmeyen hata"));
            }
        });
    </script>
</AdminLayout>
