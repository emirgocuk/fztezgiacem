---
import "../styles/global.css";
import Footer from "../components/Footer.astro";
import { SEO } from "astro-seo";
import ScrollToTop from "../components/ScrollToTop.astro";
import { ClientRouter } from "astro:transitions";

// Fonts
import "@fontsource/nunito/300.css";
import "@fontsource/nunito/400.css";
import "@fontsource/nunito/500.css";
import "@fontsource/nunito/600.css";
import "@fontsource/nunito/700.css";

interface Props {
  title: string;
  description?: string;
  image?: string;
  articleDate?: string;
  showBackgroundEffects?: boolean;
}

const {
  title,
  description = "Uzman Fizyoterapist ile sağlıklı bir yaşama adım atın. Pediatrik rehabilitasyon ve duyu bütünleme terapisi.",
  image = "/og-image.jpg",
  articleDate,
  showBackgroundEffects = true,
} = Astro.props;

const isHomepage = Astro.url.pathname === "/" || Astro.url.pathname === "";

const canonicalURL = new URL(Astro.url.pathname, Astro.site);

// Fetch Site Settings (Dynamic SEO)
import { pb } from "../lib/pocketbase";
let siteSettings = {
  phone: "+905555555555",
  email: "ezgiacem97@gmail.com",
  address: "Adana, Türkiye",
  social_links: {},
};

try {
  const settings = await pb.collection("site_settings").getFirstListItem("");
  if (settings) {
    siteSettings = {
      ...siteSettings,
      ...settings,
      email: settings.contact_email || siteSettings.email,
    };
  }
} catch (e) {
  // Fallback to defaults if collection doesn't exist or is empty
  console.log("Site settings not found, using defaults.");
}
---

<!doctype html>
<html lang="tr" class="scroll-smooth">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width" />
    <link rel="icon" type="image/svg+xml" href="/logo.svg" />
    <meta name="generator" content={Astro.generator} />

    <!-- Local Fonts: Nunito -->
    <!-- Managed by @fontsource/nunito in the frontmatter imports -->
    <ClientRouter />

    <SEO
      title={title}
      description={description}
      canonical={canonicalURL.toString()}
      openGraph={{
        basic: {
          title: title,
          type: articleDate ? "article" : "website",
          image: new URL(image, Astro.url).toString(),
        },
        optional: {
          description: description,
        },
      }}
      twitter={{
        card: "summary_large_image",
        title: title,
        description: description,
        image: new URL(image, Astro.url).toString(),
      }}
      extend={{
        meta: articleDate
          ? [{ property: "article:published_time", content: articleDate }]
          : [],
      }}
    />

    <script
      type="application/ld+json"
      is:inline
      set:html={JSON.stringify({
        "@context": "https://schema.org",
        "@type": "Physician",
        name: "Fizyoterapist Ezgi Acem",
        image: "https://fztezgiacem.com/og-image.jpg",
        "@id": "https://fztezgiacem.com",
        url: "https://fztezgiacem.com",
        telephone: siteSettings.phone,
        email: siteSettings.email,
        medicalSpecialty: ["Pediatric", "Physiotherapy", "Rehabilitation"],
        knowsAbout: [
          "Duyu Bütünleme Terapisi",
          "Pediatrik Rehabilitasyon",
          "Riskli Bebek Takibi",
          "Çocuk Fizyoterapisi",
        ],
        address: {
          "@type": "PostalAddress",
          addressLocality: "Adana",
          addressRegion: "Adana",
          addressCountry: "TR",
          streetAddress: siteSettings.address,
        },
        openingHoursSpecification: [
          {
            "@type": "OpeningHoursSpecification",
            dayOfWeek: ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday"],
            opens: "09:00",
            closes: "18:00",
          },
          {
            "@type": "OpeningHoursSpecification",
            dayOfWeek: "Saturday",
            opens: "10:00",
            closes: "15:00",
          },
        ],
      })}
    />
    <link rel="apple-touch-icon" href="/logo.svg" />
    <link rel="apple-touch-icon" href="/logo.svg" />
    <style is:global>
      :root {
        --color-primary: #ff8a65; /* Soft Orange */
        --color-secondary: #4dd0e1; /* Cyan */
        --color-tertiary: #aed581; /* Light Green */
        --color-text: #455a64; /* Blue Grey */
        --bg-soft: #fff3e0; /* Very light orange/cream */
      }
      body {
        font-family: "Nunito", sans-serif;
      }

      /* NProgress Custom Colors */
      #nprogress .bar {
        background: #ff8a65 !important;
        height: 3px !important;
      }
      #nprogress .peg {
        box-shadow:
          0 0 10px #ff8a65,
          0 0 5px #ff8a65 !important;
      }
      #nprogress .spinner {
        display: none !important; /* Hide spinner, we just want the bar */
      }
    </style>

    <script>
      import nprogress from "nprogress";
      import "nprogress/nprogress.css";

      nprogress.configure({
        showSpinner: false,
        minimum: 0.1,
        speed: 500,
      });

      // Hook into Astro's View Transitions
      document.addEventListener("astro:before-preparation", () => {
        nprogress.start();
      });

      document.addEventListener("astro:after-swap", () => {
        // Prepare for the new page view
      });

      document.addEventListener("astro:page-load", () => {
        nprogress.done();
      });
    </script>
  </head>
  <body
    class="bg-[#FAFAFA] text-slate-700 antialiased min-h-dvh flex flex-col relative overflow-x-hidden selection:bg-orange-200 selection:text-orange-900"
  >
    <!-- Global Ambient Background (Static & Performant) -->
    {
      showBackgroundEffects && (
        <div
          class={`fixed inset-0 z-[-1] pointer-events-none ${!isHomepage ? "hidden md:block" : ""}`}
          style="background: 
                radial-gradient(circle at 15% 5%, rgba(255, 138, 101, 0.05), transparent 40%),
                radial-gradient(circle at 85% 30%, rgba(77, 208, 225, 0.05), transparent 40%),
                radial-gradient(circle at 0% 90%, rgba(174, 213, 129, 0.05), transparent 40%);"
        />
      )
    }
    <header
      class="fixed top-6 left-1/2 -translate-x-1/2 z-[100] w-[95%] md:w-full md:max-w-5xl transition-all duration-300"
    >
      <div
        class={`bg-white/90 ${!isHomepage ? "md:backdrop-blur-md" : "backdrop-blur-md"} border border-white/40 shadow-xl rounded-full px-6 py-3 flex items-center justify-between`}
      >
        <!-- Logo -->
        <a
          href="/"
          class="font-extrabold text-xl tracking-tight text-slate-700 flex items-center gap-1 group"
          aria-label="Fizyoterapist Ezgi Acem Ana Sayfa"
        >
          <span
            class="w-8 h-8 md:w-12 md:h-12 flex items-center justify-center group-hover:rotate-12 transition-transform filter drop-shadow-md"
          >
            <img
              src="/logo.svg"
              alt="Fzt Ezgi Acem Logo"
              class="w-full h-full object-contain"
            />
          </span>
          <span class="whitespace-nowrap"
            >Fzt. Ezgi <span class="text-[#FF8A65]">ACEM</span></span
          >
        </a>

        <!-- Desktop Nav -->
        <nav class="hidden md:flex items-center gap-1">
          <a
            href="/"
            class="px-4 py-2 text-base font-medium text-slate-600 hover:text-[#FF8A65] rounded-full hover:bg-orange-50 transition-colors"
            >Ana Sayfa</a
          >
          <a
            href="/blog"
            class="px-4 py-2 text-base font-medium text-slate-600 hover:text-[#FF8A65] rounded-full hover:bg-orange-50 transition-colors"
            >Yazılar</a
          >
          <a
            href="/hakkimda"
            class="px-4 py-2 text-base font-medium text-slate-600 hover:text-[#FF8A65] rounded-full hover:bg-orange-50 transition-colors"
            >Biyografi</a
          >
          <a
            href="/uzmanlik-alanlarim"
            class="px-4 py-2 text-base font-medium text-slate-600 hover:text-[#FF8A65] rounded-full hover:bg-orange-50 transition-colors"
            >Uzmanlık Alanlarım</a
          >
          <a
            href="/iletisim"
            class="px-4 py-2 text-base font-medium text-slate-600 hover:text-[#FF8A65] rounded-full hover:bg-orange-50 transition-colors"
            >İletişim</a
          >
        </nav>

        <!-- Mobile Menu Toggle Button -->
        <label
          for="mobileMenuCheckbox"
          class="md:hidden p-2 text-gray-600 hover:bg-gray-100 rounded-full transition-colors cursor-pointer select-none"
          aria-label="Menüyü Aç"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="28"
            height="28"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <line x1="3" x2="21" y1="6" y2="6"></line>
            <line x1="3" x2="21" y1="12" y2="12"></line>
            <line x1="3" x2="21" y1="18" y2="18"></line>
          </svg>
        </label>
      </div>
    </header>

    <!-- Mobile Menu Controller -->
    <input type="checkbox" id="mobileMenuCheckbox" class="peer hidden" />

    <!-- Full Screen Mobile Menu Overlay -->
    <div
      class="fixed inset-0 z-[200] bg-[#fff3e0] hidden peer-checked:flex flex-col items-center justify-center animate-in fade-in duration-300 md:hidden"
    >
      <!-- Close Button -->
      <label
        for="mobileMenuCheckbox"
        class="absolute top-6 right-6 p-3 text-slate-700 hover:bg-orange-100 rounded-full cursor-pointer transition-colors"
        aria-label="Menüyü Kapat"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="32"
          height="32"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
        >
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </label>

      <!-- Mobile Nav Links -->
      <nav class="flex flex-col items-center gap-6 w-full px-6">
        <a
          href="/"
          class="mobile-menu-link group flex items-center justify-center gap-3 w-full p-2 text-2xl font-bold text-slate-700 hover:text-[#FF8A65] transition-colors"
        >
          <span>Ana Sayfa</span>
          <svg
            class="w-6 h-6 animate-spin text-[#FF8A65] hidden group-[.loading]:block"
            xmlns="http://www.w3.org/2000/svg"
            fill="none"
            viewBox="0 0 24 24"
          >
            <circle
              class="opacity-25"
              cx="12"
              cy="12"
              r="10"
              stroke="currentColor"
              stroke-width="4"></circle>
            <path
              class="opacity-75"
              fill="currentColor"
              d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
            ></path>
          </svg>
        </a>
        <a
          href="/blog"
          class="mobile-menu-link group flex items-center justify-center gap-3 w-full p-2 text-2xl font-bold text-slate-700 hover:text-[#FF8A65] transition-colors"
        >
          <span>Yazılar</span>
          <svg
            class="w-6 h-6 animate-spin text-[#FF8A65] hidden group-[.loading]:block"
            xmlns="http://www.w3.org/2000/svg"
            fill="none"
            viewBox="0 0 24 24"
          >
            <circle
              class="opacity-25"
              cx="12"
              cy="12"
              r="10"
              stroke="currentColor"
              stroke-width="4"></circle>
            <path
              class="opacity-75"
              fill="currentColor"
              d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
            ></path>
          </svg>
        </a>
        <a
          href="/hakkimda"
          class="mobile-menu-link group flex items-center justify-center gap-3 w-full p-2 text-2xl font-bold text-slate-700 hover:text-[#FF8A65] transition-colors"
        >
          <span>Biyografi</span>
          <svg
            class="w-6 h-6 animate-spin text-[#FF8A65] hidden group-[.loading]:block"
            xmlns="http://www.w3.org/2000/svg"
            fill="none"
            viewBox="0 0 24 24"
          >
            <circle
              class="opacity-25"
              cx="12"
              cy="12"
              r="10"
              stroke="currentColor"
              stroke-width="4"></circle>
            <path
              class="opacity-75"
              fill="currentColor"
              d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
            ></path>
          </svg>
        </a>
        <a
          href="/uzmanlik-alanlarim"
          class="mobile-menu-link group flex items-center justify-center gap-3 w-full p-2 text-2xl font-bold text-slate-700 hover:text-[#FF8A65] transition-colors"
        >
          <span>Uzmanlık Alanlarım</span>
          <svg
            class="w-6 h-6 animate-spin text-[#FF8A65] hidden group-[.loading]:block"
            xmlns="http://www.w3.org/2000/svg"
            fill="none"
            viewBox="0 0 24 24"
          >
            <circle
              class="opacity-25"
              cx="12"
              cy="12"
              r="10"
              stroke="currentColor"
              stroke-width="4"></circle>
            <path
              class="opacity-75"
              fill="currentColor"
              d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
            ></path>
          </svg>
        </a>
        <a
          href="/iletisim"
          class="mobile-menu-link group flex items-center justify-center gap-3 w-full px-8 py-3 text-xl font-bold text-white bg-[#FF8A65] hover:bg-[#FF7043] rounded-full shadow-lg shadow-orange-200 transition-all"
        >
          <span>Randevu Al</span>
          <svg
            class="w-5 h-5 animate-spin text-white hidden group-[.loading]:block"
            xmlns="http://www.w3.org/2000/svg"
            fill="none"
            viewBox="0 0 24 24"
          >
            <circle
              class="opacity-25"
              cx="12"
              cy="12"
              r="10"
              stroke="currentColor"
              stroke-width="4"></circle>
            <path
              class="opacity-75"
              fill="currentColor"
              d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
            ></path>
          </svg>
        </a>
      </nav>
    </div>

    <!-- Script to handle menu state -->
    <script>
      document.addEventListener("astro:page-load", () => {
        const checkbox = document.getElementById("mobileMenuCheckbox");
        const links = document.querySelectorAll(".mobile-menu-link");

        links.forEach((link) => {
          link.addEventListener("click", () => {
            // Instead of closing immediately, we add a loading class
            // The menu will effectively 'close' when the new page replaces this one
            link.classList.add("loading");
          });
        });
      });
    </script>

    <main class="flex-1 w-full">
      <slot />
    </main>

    <Footer />
    <ScrollToTop />
  </body>
</html>

<style is:global>
  @keyframes blob {
    0% {
      transform: translate(0px, 0px) scale(1);
    }
    33% {
      transform: translate(30px, -50px) scale(1.1);
    }
    66% {
      transform: translate(-20px, 20px) scale(0.9);
    }
    100% {
      transform: translate(0px, 0px) scale(1);
    }
  }
  .animate-blob {
    animation: blob 7s infinite;
    transform: translate3d(0, 0, 0);
    backface-visibility: hidden;
  }
  .animation-delay-2000 {
    animation-delay: 2s;
  }
  .animation-delay-4000 {
    animation-delay: 4s;
  }
</style>
