---
import AdminLayout from "../../../layouts/AdminLayout.astro";
import TiptapEditor from "../../../components/admin/TiptapEditor.jsx";
import ImageUploadWithCrop from "../../../components/admin/ImageUploadWithCrop.jsx";

const { id } = Astro.params;
const isEdit = !!id;
const title = isEdit ? "YazÄ±yÄ± DÃ¼zenle" : "Yeni YazÄ± Ekle";

// Note: For [id].astro we need getStaticPaths if we want to pre-render.
// But internal admin pages are better as SPA/Client-only in Astro if the content is dynamic and private.
// Astro supports 'output: hybrid' or 'server'. But we are on 'static' default.
// To make this work dynamically without rebuilding for every admin page visit, we should use a CLIENT SIDE ROUTER or just rely on a catch-all route if possible, OR just use query params?
// Actually, in Static mode, [id].astro REQUIRES getStaticPaths.
// CHANGE STRATEGY: Use `src/pages/admin/editor.astro` with query param `?id=` for simplicity in Static mode without full re-builds for admin panel structure.
// OR use `src/pages/admin/posts/[...id].astro` but again requires static paths.
// LET'S USE: `src/pages/admin/posts/new.astro` and `src/pages/admin/posts/edit.astro` (taking ID from URL param via JS).

// This file will represent the EDITOR generic structure, we'll save it as 'new.astro' first.
---

<AdminLayout title={title}>
    <div class="max-w-4xl mx-auto">
        <h1 class="text-2xl font-bold mb-6">{title}</h1>

        <form
            id="postForm"
            class="space-y-6 bg-white p-8 rounded-xl shadow-sm border border-gray-100"
        >
            <!-- Developer Tools -->
            <div id="devTools" class="hidden justify-end mb-4">
                <button
                    type="button"
                    id="fillTestDataBtn"
                    class="bg-purple-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-purple-700 transition flex items-center gap-2"
                >
                    <span>ğŸ§ª Test Verisi Doldur</span>
                </button>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="space-y-4">
                    <div>
                        <label
                            class="block text-sm font-medium text-gray-700 mb-1"
                            >BaÅŸlÄ±k</label
                        >
                        <input
                            type="text"
                            name="title"
                            required
                            class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-[#1E3A1A] outline-none"
                            placeholder="YazÄ± baÅŸlÄ±ÄŸÄ±"
                        />
                    </div>

                    <div>
                        <label
                            class="block text-sm font-medium text-gray-700 mb-1"
                            >Slug (URL)</label
                        >
                        <input
                            type="text"
                            name="slug"
                            class="w-full px-4 py-2 border rounded-lg bg-gray-50 text-gray-500"
                            placeholder="Otomatik oluÅŸturulur"
                            readonly
                        />
                    </div>

                    <div>
                        <label
                            class="block text-sm font-medium text-gray-700 mb-1"
                            >Kategori</label
                        >
                        <select
                            name="category"
                            class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-[#1E3A1A] outline-none"
                        >
                            <option value="Genel">Genel</option>
                            <option value="Manuel Terapi">Manuel Terapi</option>
                            <option value="DEHB">DEHB</option>
                            <option value="Egzersiz">Egzersiz</option>
                        </select>
                    </div>

                    <div>
                        <ImageUploadWithCrop client:load />
                    </div>
                </div>

                <div class="space-y-4">
                    <div>
                        <label
                            class="block text-sm font-medium text-gray-700 mb-1"
                            >Ã–zet</label
                        >
                        <textarea
                            name="summary"
                            rows="4"
                            class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-[#1E3A1A] outline-none resize-none"
                            placeholder="KÄ±sa aÃ§Ä±klama..."></textarea>
                    </div>
                    <div>
                        <label
                            class="block text-sm font-medium text-gray-700 mb-1"
                            >YayÄ±n Tarihi</label
                        >
                        <input
                            type="date"
                            name="published_date"
                            required
                            class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-[#1E3A1A] outline-none"
                        />
                    </div>
                </div>

                <!-- SEO Section -->
                <div class="md:col-span-2 border-t pt-6 mt-2">
                    <h3
                        class="text-lg font-bold text-gray-900 mb-4 flex items-center gap-2"
                    >
                        <span>ğŸ”</span> SEO AyarlarÄ±
                    </h3>
                    <div
                        class="grid grid-cols-1 md:grid-cols-2 gap-6 bg-gray-50 p-6 rounded-xl border border-gray-200"
                    >
                        <!-- SEO Title -->
                        <div class="md:col-span-2">
                            <label
                                class="block text-sm font-medium text-gray-700 mb-1"
                            >
                                SEO BaÅŸlÄ±ÄŸÄ± <span
                                    class="text-xs text-gray-500 font-normal"
                                    >(Opsiyonel - Google'da gÃ¶rÃ¼necek baÅŸlÄ±k)</span
                                >
                            </label>
                            <input
                                type="text"
                                name="seo_title"
                                maxlength="60"
                                class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-[#1E3A1A] outline-none"
                                placeholder="Ã–rn: Bel AÄŸrÄ±sÄ± Tedavisi | Fzt. Ezgi Acem"
                            />
                            <div class="text-right text-xs text-gray-400 mt-1">
                                <span id="seoTitleCount">0</span>/60
                            </div>
                        </div>

                        <!-- SEO Description -->
                        <div class="md:col-span-2">
                            <label
                                class="block text-sm font-medium text-gray-700 mb-1"
                            >
                                SEO AÃ§Ä±klamasÄ± <span
                                    class="text-xs text-gray-500 font-normal"
                                    >(Opsiyonel - Meta Description)</span
                                >
                            </label>
                            <textarea
                                name="seo_description"
                                rows="2"
                                maxlength="160"
                                class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-[#1E3A1A] outline-none resize-none"
                                placeholder="Arama sonuÃ§larÄ±nda gÃ¶rÃ¼necek kÄ±sa aÃ§Ä±klama..."
                            ></textarea>
                            <div class="text-right text-xs text-gray-400 mt-1">
                                <span id="seoDescCount">0</span>/160
                            </div>
                        </div>

                        <!-- Keywords -->
                        <div class="md:col-span-2">
                            <label
                                class="block text-sm font-medium text-gray-700 mb-1"
                            >
                                Anahtar Kelimeler <span
                                    class="text-xs text-gray-500 font-normal"
                                    >(VirgÃ¼lle ayÄ±rÄ±n)</span
                                >
                            </label>
                            <input
                                type="text"
                                name="keywords"
                                class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-[#1E3A1A] outline-none"
                                placeholder="fizyoterapi, adana, bel aÄŸrÄ±sÄ±, manuel terapi"
                            />
                        </div>
                    </div>
                </div>
            </div>

            <div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2"
                        >Ä°Ã§erik</label
                    >
                    <TiptapEditor
                        client:only="react"
                        content=""
                        targetInputId="contentHidden"
                    />
                    <!-- Removed 'required' attribute to prevent browser validation on invisible field -->
                    <input
                        type="text"
                        name="content"
                        id="contentHidden"
                        class="opacity-0 h-1 pointer-events-none"
                    />
                </div>

                <div class="flex justify-end pt-4">
                    <button
                        type="submit"
                        id="submitBtn"
                        class="bg-[#1E3A1A] text-white px-8 py-3 rounded-lg font-bold hover:bg-[#1E3A1A]/90 transition"
                    >
                        Kaydet
                    </button>
                </div>
            </div>
        </form>

        <script>
            import { pb } from "../../../lib/pocketbase";
            import { uploadToImgBB } from "../../../lib/imgbb";

            // Turkish Character Map for Slug
            const trMap: { [key: string]: string } = {
                Ã§: "c",
                ÄŸ: "g",
                ÅŸ: "s",
                Ã¼: "u",
                Ã¶: "o",
                Ä±: "i",
                Ã‡: "c",
                Ä: "g",
                Å: "s",
                Ãœ: "u",
                Ã–: "o",
                Ä°: "i",
            };

            // Slug Generator
            document
                .querySelector('input[name="title"]')
                ?.addEventListener("input", (e) => {
                    const val = (e.target as HTMLInputElement).value;

                    let slug = val
                        .split("")
                        .map((c) => trMap[c] || c)
                        .join("")
                        .toLowerCase();
                    slug = slug
                        .replace(/[^a-z0-9\s-]/g, "") // Remove non-alphanumeric chars (except spaces and hyphens)
                        .replace(/\s+/g, "-") // Replace spaces with hyphens
                        .replace(/-+/g, "-"); // Remove duplicate hyphens

                    const slugInput = document.querySelector(
                        'input[name="slug"]',
                    ) as HTMLInputElement;
                    if (slugInput) slugInput.value = slug;
                });

            // SEO Character Counters
            document
                .querySelector('input[name="seo_title"]')
                ?.addEventListener("input", (e) => {
                    const el = e.target as HTMLInputElement;
                    const count = el.value.length;
                    const countEl = document.getElementById("seoTitleCount");
                    if (countEl) {
                        countEl.innerText = String(count);
                        countEl.parentElement!.classList.toggle(
                            "text-red-500",
                            count > 60,
                        );
                    }
                });

            document
                .querySelector('textarea[name="seo_description"]')
                ?.addEventListener("input", (e) => {
                    const el = e.target as HTMLTextAreaElement;
                    const count = el.value.length;
                    const countEl = document.getElementById("seoDescCount");
                    if (countEl) {
                        countEl.innerText = String(count);
                        countEl.parentElement!.classList.toggle(
                            "text-red-500",
                            count > 160,
                        );
                    }
                });

            // Form Submission
            const form = document.getElementById("postForm") as HTMLFormElement;
            form?.addEventListener("submit", async (e) => {
                e.preventDefault();

                // Manual Content Validation
                const contentInput = document.getElementById(
                    "contentHidden",
                ) as HTMLInputElement;
                if (
                    !contentInput ||
                    !contentInput.value.trim() ||
                    contentInput.value === "<p></p>"
                ) {
                    alert("LÃ¼tfen iÃ§erik alanÄ±nÄ± doldurun.");
                    return;
                }

                const btn = document.getElementById(
                    "submitBtn",
                ) as HTMLButtonElement;
                const originalText = btn.innerText;

                try {
                    btn.disabled = true;
                    btn.innerText = "YÃ¼kleniyor...";

                    const formData = new FormData(form);
                    // Handle Cropped Image (Base64)
                    const croppedBase64 = formData.get(
                        "cropped_image",
                    ) as string;
                    let imageUrl = "";

                    if (
                        croppedBase64 &&
                        croppedBase64.startsWith("data:image")
                    ) {
                        btn.innerText = "GÃ¶rsel YÃ¼kleniyor...";
                        const res = await fetch(croppedBase64);
                        const blob = await res.blob();
                        const file = new File([blob], "cover_image.webp", {
                            type: "image/webp",
                        });
                        imageUrl = await uploadToImgBB(file);
                    }

                    // Prepare PB Data
                    // Prepare PB Data
                    // Convert date to ISO string for PocketBase
                    let pubDate = formData.get("published_date");

                    // Tarih boÅŸsa veya geÃ§ersizse undefined gÃ¶nder (PB null kabul eder)
                    let isoDate = "";
                    if (pubDate) {
                        const d = new Date(pubDate as string);
                        if (!isNaN(d.getTime())) {
                            isoDate = d.toISOString();
                        }
                    }

                    const data = {
                        title: formData.get("title"),
                        slug: formData.get("slug"),
                        category: formData.get("category"),
                        summary: formData.get("summary"),
                        published_date: isoDate || null, // BoÅŸsa null gÃ¶nder
                        content: contentInput.value, // Tiptap content
                        image: imageUrl,
                        seo_title: formData.get("seo_title"),
                        seo_description: formData.get("seo_description"),
                        keywords: formData.get("keywords"),
                    };

                    console.log(
                        "ğŸ“¤ Sending Data to PB (JSON):",
                        JSON.stringify(data, null, 2),
                    ); // Debug log full JSON

                    await pb.collection("posts").create(data);
                    alert("YazÄ± baÅŸarÄ±yla oluÅŸturuldu!");
                    window.location.href = "/admin";
                } catch (err: any) {
                    console.error(err);
                    let msg = err.message;
                    if (err.response?.data) {
                        // Format PocketBase validation errors (e.g. title: cannot be empty)
                        msg +=
                            "\n" +
                            Object.entries(err.response.data)
                                .map(
                                    ([key, val]: [string, any]) =>
                                        `â€¢ ${key}: ${val.message}`,
                                )
                                .join("\n");
                    }
                    alert("Hata OluÅŸtu:\n" + msg);
                } finally {
                    btn.disabled = false;
                    btn.innerText = originalText;
                }
            });
            // Dev Mode Check & Test Data Generator
            const isDevMode = localStorage.getItem("devMode") === "true";
            if (isDevMode) {
                document.getElementById("devTools")?.classList.remove("hidden");
                document.getElementById("devTools")?.classList.add("flex");
            }

            document
                .getElementById("fillTestDataBtn")
                ?.addEventListener("click", () => {
                    const titles = [
                        "Bel AÄŸrÄ±sÄ± Ä°Ã§in 5 Etkili Egzersiz",
                        "Masa BaÅŸÄ± Ã‡alÄ±ÅŸanlar Ä°Ã§in DuruÅŸ Ã–nerileri",
                        "Skolyoz Tedavisinde Yeni YaklaÅŸÄ±mlar",
                        "Spor YaralanmalarÄ±ndan Korunma YollarÄ±",
                        "Manuel Terapi Nedir? Kimlere UygulanÄ±r?",
                        "Boyun DÃ¼zleÅŸmesi ve Tedavisi",
                        "Hamilelikte Bel AÄŸrÄ±sÄ± ile BaÅŸa Ã‡Ä±kma",
                    ];
                    const categories = [
                        "Genel",
                        "Manuel Terapi",
                        "DEHB",
                        "Egzersiz",
                    ];

                    const randomTitle =
                        titles[Math.floor(Math.random() * titles.length)];
                    const randomCategory =
                        categories[
                            Math.floor(Math.random() * categories.length)
                        ];

                    // Lorem Ipsum
                    const lorem = `
            <h2>GiriÅŸ</h2>
            <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.</p>
            <h3>Neden Ã–nemli?</h3>
            <p>Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.</p>
            <ul>
                <li>Ã–nemli nokta 1</li>
                <li>Ã–nemli nokta 2</li>
                <li>Ã–nemli nokta 3</li>
            </ul>
            <blockquote>"SaÄŸlÄ±k en bÃ¼yÃ¼k hazinedir." - Anonim</blockquote>
            <p>SonuÃ§ olarak, dÃ¼zenli egzersiz ve doÄŸru duruÅŸ hayat kalitesini artÄ±rÄ±r.</p>
        `;

                    // Fill Form
                    (
                        document.querySelector(
                            'input[name="title"]',
                        ) as HTMLInputElement
                    ).value = randomTitle;
                    (
                        document.querySelector(
                            'select[name="category"]',
                        ) as HTMLSelectElement
                    ).value = randomCategory;
                    (
                        document.querySelector(
                            'textarea[name="summary"]',
                        ) as HTMLTextAreaElement
                    ).value =
                        "Bu otomatik oluÅŸturulmuÅŸ bir test Ã¶zetidir. Lorem ipsum dolor sit amet.";
                    (
                        document.querySelector(
                            'input[name="published_date"]',
                        ) as HTMLInputElement
                    ).value = new Date().toISOString().split("T")[0];

                    // Trigger Slug Generation & Make Unique
                    const slugInput = document.querySelector(
                        'input[name="slug"]',
                    ) as HTMLInputElement;
                    document
                        .querySelector('input[name="title"]')
                        ?.dispatchEvent(new Event("input"));

                    // Add current timestamp to slug to ensure uniqueness during testing
                    setTimeout(() => {
                        if (slugInput)
                            slugInput.value =
                                slugInput.value +
                                "-" +
                                Date.now().toString().slice(-4);
                    }, 100);

                    // Fill Editor via Custom Event
                    window.dispatchEvent(
                        new CustomEvent("set-tiptap-content", {
                            detail: lorem,
                        }),
                    );
                });
        </script>
    </div>
</AdminLayout>
