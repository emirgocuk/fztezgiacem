---
import BaseLayout from "../../layouts/BaseLayout.astro";
import { pb, type Post, getPbImageURL } from "../../lib/pocketbase";
import LeadCaptureForm from "../../components/LeadCaptureForm.jsx";

// SSG Mode: Generate paths for all posts
export async function getStaticPaths() {
  try {
    const posts = await pb.collection("posts").getFullList<Post>();
    return posts.map((post) => ({
      params: { slug: post.slug },
      props: { post },
    }));
  } catch (err) {
    console.error("Error in getStaticPaths:", err);
    return [];
  }
}

const { slug } = Astro.params;
const { post } = Astro.props;

// No need to fetch here anymore since we pass it in props
// But if we wanted to be safe/hybrid, we could keep the fetch as fallback,
// strictly for SSG though, props are guaranteed.

// Calculate Read Time (rough estimate)
const wordsPerMinute = 200;
const content = post.content || "";
const textLength = content.split(/\s+/).length;
const readTime = Math.ceil(textLength / wordsPerMinute);

const imageURL = post.image
  ? `${getPbImageURL(post.collectionId, post.id, post.image)}?thumb=1200x675`
  : undefined;

// JSON-LD Schema
const schemaData = {
  "@context": "https://schema.org",
  "@type": "MedicalWebPage",
  name: post.title,
  description: post.summary,
  audience: {
    "@type": "MedicalAudience",
    audienceType: "Patients",
  },
  mainEntity: {
    "@type": "Article",
    headline: post.title,
    image: imageURL ? [imageURL] : [],
    datePublished: post.published_date,
    dateModified: post.updated,
    author: {
      "@type": "Person",
      name: "Fizyoterapist Ezgi Acem",
    },
    publisher: {
      "@type": "Organization",
      name: "Fizyoterapist Ezgi Acem",
      logo: {
        "@type": "ImageObject",
        url: new URL("/logo.svg", Astro.site),
      },
    },
  },
};
---

<BaseLayout
  title={post.seo_title || post.title}
  description={post.seo_description || post.summary}
  image={imageURL}
  articleDate={post.published_date}
  showBackgroundEffects={false}
>
  {
    post.keywords && (
      <meta slot="head" name="keywords" content={post.keywords} />
    )
  }
  <!-- Schema.org JSON-LD -->
  <script
    is:inline
    type="application/ld+json"
    set:html={JSON.stringify(schemaData)}
  />

  <div
    class="relative min-h-screen pt-36 pb-20 overflow-hidden md:bg-gradient-to-b md:from-orange-50/50 md:to-white bg-[#FAFAFA]"
  >
    <!-- Decorative background elements -->
    <div
      class="absolute top-0 left-0 w-full h-full overflow-hidden -z-10 pointer-events-none hidden md:block"
    >
      <div
        class="absolute top-[-10%] right-[-5%] w-96 h-96 bg-yellow-200/40 rounded-full blur-3xl animate-blob"
      >
      </div>
      <div
        class="absolute bottom-[-10%] left-[-5%] w-96 h-96 bg-blue-200/40 rounded-full blur-3xl animate-blob animation-delay-2000"
      >
      </div>
    </div>

    <article class="max-w-4xl mx-auto px-4 relative z-10">
      <div class="mb-8 text-center">
        <span
          class="inline-block bg-green-100 text-[#1E3A1A] text-sm font-semibold px-3 py-1 rounded-full mb-4"
        >
          {post.category}
        </span>
        <h1
          class="text-3xl md:text-5xl font-bold text-gray-900 mb-6 leading-tight"
        >
          {post.title}
        </h1>

        <div
          class="flex items-center justify-center gap-6 text-gray-500 text-sm"
        >
          <time datetime={post.published_date}>
            {
              new Date(post.published_date).toLocaleDateString("tr-TR", {
                day: "numeric",
                month: "long",
                year: "numeric",
              })
            }
          </time>
          <div class="flex items-center gap-1">
            <span>‚è±</span>
            {readTime} dk okuma
          </div>
          {/* View Count Hidden per user request */}
          {
            /*
          <div class="flex items-center gap-1 ml-4" title="Okunma Sayƒ±sƒ±">
            <span>üëÅÔ∏è</span>
            <span id="view-count" data-post-id={post.id}>{post.views || 0}</span>
          </div>
          */
          }
        </div>
      </div>

      {
        imageURL && (
          <div class="prose prose-lg mx-auto mb-12 rounded-2xl overflow-hidden shadow-lg w-full h-auto">
            <img
              src={imageURL}
              alt={post.title}
              width={1200}
              height={675}
              class="w-full h-auto object-cover"
            />
          </div>
        )
      }

      <div
        class="prose prose-lg prose-green mx-auto bg-white p-8 md:p-12 rounded-2xl shadow-sm border border-gray-100"
      >
        <Fragment set:html={post.content} />
      </div>

      <div class="max-w-2xl mx-auto mt-12">
        <LeadCaptureForm
          client:visible
          source={`blog_post_${post.slug}`}
          title="Bu yazƒ±yƒ± beƒüendiniz mi?"
          className="bg-orange-50/50 border-orange-100"
        />
      </div>

      {/* Share / Tags / Navigation potentially here */}
      <div class="mt-12 text-center">
        <a
          href="/blog"
          class="inline-flex items-center gap-2 text-[#1E3A1A] font-semibold hover:underline"
        >
          <span>‚Üê</span> Blog'a D√∂n
        </a>
      </div>
    </article>
  </div>
</BaseLayout>
