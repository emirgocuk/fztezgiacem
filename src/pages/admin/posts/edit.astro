---
import AdminLayout from "../../../layouts/AdminLayout.astro";
import TiptapEditor from "../../../components/admin/TiptapEditor.jsx";
import ImageUploadWithCrop from "../../../components/admin/ImageUploadWithCrop.jsx";

const title = "Yazƒ±yƒ± D√ºzenle";
---

<AdminLayout title={title}>
    <div class="max-w-4xl mx-auto">
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-2xl font-bold">{title}</h1>
            <a
                href="/admin"
                class="text-gray-500 hover:text-gray-900 border px-3 py-1 rounded"
                >‚Üê Geri</a
            >
        </div>

        <div id="loadingState" class="text-center py-12">
            <p class="text-gray-500">Yazƒ± bilgileri y√ºkleniyor...</p>
        </div>

        <form
            id="postForm"
            class="hidden space-y-6 bg-white p-8 rounded-xl shadow-sm border border-gray-100"
        >
            <input type="hidden" name="id" id="postId" />

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="space-y-4">
                    <div>
                        <label
                            class="block text-sm font-medium text-gray-700 mb-1"
                            >Ba≈ülƒ±k</label
                        >
                        <input
                            type="text"
                            name="title"
                            required
                            class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-[#1E3A1A] outline-none"
                            placeholder="Yazƒ± ba≈ülƒ±ƒüƒ±"
                        />
                    </div>

                    <div>
                        <label
                            class="block text-sm font-medium text-gray-700 mb-1"
                            >Slug (URL)</label
                        >
                        <input
                            type="text"
                            name="slug"
                            class="w-full px-4 py-2 border rounded-lg bg-gray-50 text-gray-500"
                            placeholder="Otomatik olu≈üturulur"
                        />
                    </div>

                    <div>
                        <label
                            class="block text-sm font-medium text-gray-700 mb-1"
                            >Kategori</label
                        >
                        <select
                            name="category"
                            class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-[#1E3A1A] outline-none"
                        >
                            <option value="Genel">Genel</option>
                            <option value="Manuel Terapi">Manuel Terapi</option>
                            <option value="DEHB">DEHB</option>
                            <option value="Egzersiz">Egzersiz</option>
                        </select>
                    </div>

                    <div>
                        <ImageUploadWithCrop client:load />
                    </div>
                </div>

                <div class="space-y-4">
                    <div>
                        <label
                            class="block text-sm font-medium text-gray-700 mb-1"
                            >√ñzet</label
                        >
                        <textarea
                            name="summary"
                            rows="4"
                            class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-[#1E3A1A] outline-none resize-none"
                            placeholder="Kƒ±sa a√ßƒ±klama..."></textarea>
                    </div>
                    <div>
                        <label
                            class="block text-sm font-medium text-gray-700 mb-1"
                            >Yayƒ±n Tarihi</label
                        >
                        <input
                            type="date"
                            name="published_date"
                            required
                            class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-[#1E3A1A] outline-none"
                        />
                    </div>
                </div>
            </div>

            <!-- SEO Section -->
            <div class="md:col-span-2 border-t pt-6 mt-2">
                <h3
                    class="text-lg font-bold text-gray-900 mb-4 flex items-center gap-2"
                >
                    <span>üîç</span> SEO Ayarlarƒ±
                </h3>
                <div
                    class="grid grid-cols-1 md:grid-cols-2 gap-6 bg-gray-50 p-6 rounded-xl border border-gray-200"
                >
                    <!-- SEO Title -->
                    <div class="md:col-span-2">
                        <label
                            class="block text-sm font-medium text-gray-700 mb-1"
                        >
                            SEO Ba≈ülƒ±ƒüƒ± <span
                                class="text-xs text-gray-500 font-normal"
                                >(Opsiyonel - Google'da g√∂r√ºnecek ba≈ülƒ±k)</span
                            >
                        </label>
                        <input
                            type="text"
                            name="seo_title"
                            maxlength="60"
                            class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-[#1E3A1A] outline-none"
                            placeholder="√ñrn: Bel Aƒürƒ±sƒ± Tedavisi | Fzt. Ezgi Acem"
                        />
                        <div class="text-right text-xs text-gray-400 mt-1">
                            <span id="seoTitleCount">0</span>/60
                        </div>
                    </div>

                    <!-- SEO Description -->
                    <div class="md:col-span-2">
                        <label
                            class="block text-sm font-medium text-gray-700 mb-1"
                        >
                            SEO A√ßƒ±klamasƒ± <span
                                class="text-xs text-gray-500 font-normal"
                                >(Opsiyonel - Meta Description)</span
                            >
                        </label>
                        <textarea
                            name="seo_description"
                            rows="2"
                            maxlength="160"
                            class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-[#1E3A1A] outline-none resize-none"
                            placeholder="Arama sonu√ßlarƒ±nda g√∂r√ºnecek kƒ±sa a√ßƒ±klama..."
                        ></textarea>
                        <div class="text-right text-xs text-gray-400 mt-1">
                            <span id="seoDescCount">0</span>/160
                        </div>
                    </div>

                    <!-- Keywords -->
                    <div class="md:col-span-2">
                        <label
                            class="block text-sm font-medium text-gray-700 mb-1"
                        >
                            Anahtar Kelimeler <span
                                class="text-xs text-gray-500 font-normal"
                                >(Virg√ºlle ayƒ±rƒ±n)</span
                            >
                        </label>
                        <input
                            type="text"
                            name="keywords"
                            class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-[#1E3A1A] outline-none"
                            placeholder="fizyoterapi, adana, bel aƒürƒ±sƒ±, manuel terapi"
                        />
                    </div>
                </div>
            </div>
        </form>

        <div>
            <label class="block text-sm font-medium text-gray-700 mb-2"
                >ƒ∞√ßerik</label
            >
            <TiptapEditor
                client:only="react"
                content=""
                targetInputId="contentHidden"
            />
            <input
                type="text"
                name="content"
                id="contentHidden"
                class="opacity-0 h-1 pointer-events-none"
            />
        </div>

        <div class="flex justify-end pt-4">
            <button
                type="submit"
                id="submitBtn"
                class="bg-[#1E3A1A] text-white px-8 py-3 rounded-lg font-bold hover:bg-[#1E3A1A]/90 transition"
            >
                G√ºncelle
            </button>
        </div>
    </div>
</AdminLayout>

<script>
    import { pb } from "../../../lib/pocketbase";
    import { uploadToImgBB } from "../../../lib/imgbb";

    // Turkish Character Map
    const trMap: { [key: string]: string } = {
        √ß: "c",
        ƒü: "g",
        ≈ü: "s",
        √º: "u",
        √∂: "o",
        ƒ±: "i",
        √á: "c",
        ƒû: "g",
        ≈û: "s",
        √ú: "u",
        √ñ: "o",
        ƒ∞: "i",
    };

    const urlParams = new URLSearchParams(window.location.search);
    const postId = urlParams.get("id");
    const form = document.getElementById("postForm") as HTMLFormElement;
    const loadingState = document.getElementById("loadingState");
    let post: any;

    if (!postId) {
        alert("Hata: Yazƒ± ID bulunamadƒ±.");
        window.location.href = "/admin";
    }

    async function init() {
        try {
            if (!postId) return;
            post = await pb.collection("posts").getOne(postId);

            // Fill Form
            (document.getElementById("postId") as HTMLInputElement).value =
                post.id;
            (
                document.querySelector(
                    'input[name="title"]',
                ) as HTMLInputElement
            ).value = post.title;
            (
                document.querySelector('input[name="slug"]') as HTMLInputElement
            ).value = post.slug;
            (
                document.querySelector(
                    'select[name="category"]',
                ) as HTMLSelectElement
            ).value = post.category || "Genel";
            (
                document.querySelector(
                    'textarea[name="summary"]',
                ) as HTMLTextAreaElement
            ).value = post.summary || "";

            // SEO Fields
            (
                document.querySelector(
                    'input[name="seo_title"]',
                ) as HTMLInputElement
            ).value = post.seo_title || "";
            (
                document.querySelector(
                    'textarea[name="seo_description"]',
                ) as HTMLTextAreaElement
            ).value = post.seo_description || "";
            (
                document.querySelector(
                    'input[name="keywords"]',
                ) as HTMLInputElement
            ).value = post.keywords || "";

            // Trigger input events to update counters
            document
                .querySelector('input[name="seo_title"]')
                ?.dispatchEvent(new Event("input"));
            document
                .querySelector('textarea[name="seo_description"]')
                ?.dispatchEvent(new Event("input"));

            if (post.published_date) {
                (
                    document.querySelector(
                        'input[name="published_date"]',
                    ) as HTMLInputElement
                ).value = new Date(post.published_date)
                    .toISOString()
                    .split("T")[0];
            }

            if (post.image) {
                const setImageInterval = setInterval(() => {
                    window.dispatchEvent(
                        new CustomEvent("set-initial-image", {
                            detail: post.image,
                        }),
                    );
                }, 500);
                setTimeout(() => clearInterval(setImageInterval), 3000);
            }

            const content = post.content || "";
            const setContentInterval = setInterval(() => {
                const event = new CustomEvent("set-tiptap-content", {
                    detail: content,
                });
                window.dispatchEvent(event);
            }, 500);

            setTimeout(() => clearInterval(setContentInterval), 3000);
            (
                document.getElementById("contentHidden") as HTMLInputElement
            ).value = content;

            loadingState?.classList.add("hidden");
            form?.classList.remove("hidden");
        } catch (err: any) {
            alert("Yazƒ± y√ºklenirken hata: " + err.message);
            window.location.href = "/admin";
        }
    }

    init();

    document
        .querySelector('input[name="title"]')
        ?.addEventListener("input", (e) => {
            const val = (e.target as HTMLInputElement).value;
            let slug = val
                .split("")
                .map((c) => trMap[c] || c)
                .join("")
                .toLowerCase();
            slug = slug
                .replace(/[^a-z0-9\s-]/g, "")
                .replace(/\s+/g, "-")
                .replace(/-+/g, "-");
            const slugInput = document.querySelector(
                'input[name="slug"]',
            ) as HTMLInputElement;
            if (slugInput) slugInput.value = slug;
        });

    // SEO Character Counters
    document
        .querySelector('input[name="seo_title"]')
        ?.addEventListener("input", (e) => {
            const el = e.target as HTMLInputElement;
            const count = el.value.length;
            const countEl = document.getElementById("seoTitleCount");
            if (countEl) {
                countEl.innerText = String(count);
                countEl.parentElement!.classList.toggle(
                    "text-red-500",
                    count > 60,
                );
            }
        });

    document
        .querySelector('textarea[name="seo_description"]')
        ?.addEventListener("input", (e) => {
            const el = e.target as HTMLTextAreaElement;
            const count = el.value.length;
            const countEl = document.getElementById("seoDescCount");
            if (countEl) {
                countEl.innerText = String(count);
                countEl.parentElement!.classList.toggle(
                    "text-red-500",
                    count > 160,
                );
            }
        });

    form?.addEventListener("submit", async (e) => {
        e.preventDefault();
        const btn = document.getElementById("submitBtn") as HTMLButtonElement;
        const originalText = btn.innerText;
        const contentInput = document.getElementById(
            "contentHidden",
        ) as HTMLInputElement;

        try {
            btn.disabled = true;
            btn.innerText = "G√ºncelleniyor...";

            const formData = new FormData(form);
            let imageUrl = "";

            const croppedBase64 = formData.get("cropped_image") as string;
            if (croppedBase64 && croppedBase64.startsWith("data:image")) {
                btn.innerText = "G√∂rsel Y√ºkleniyor...";
                const res = await fetch(croppedBase64);
                const blob = await res.blob();
                const file = new File([blob], "cover_image.webp", {
                    type: "image/webp",
                });
                imageUrl = await uploadToImgBB(file);
            }

            let isoDate = "";
            let pDate = formData.get("published_date");
            if (pDate) {
                let d = new Date(pDate as string);
                if (!isNaN(d.getTime())) isoDate = d.toISOString();
            }

            const data: any = {
                title: formData.get("title"),
                slug: formData.get("slug"),
                category: formData.get("category"),
                summary: formData.get("summary"),
                published_date: isoDate || null,
                content: contentInput.value,
                seo_title: formData.get("seo_title"),
                seo_description: formData.get("seo_description"),
                keywords: formData.get("keywords"),
            };
            if (imageUrl) {
                data.image = imageUrl;
            }

            if (!postId) throw new Error("ID Missing");

            await pb.collection("posts").update(postId, data);
            alert("G√ºncelleme ba≈üarƒ±lƒ±!");
            window.location.href = "/admin";
        } catch (err: any) {
            console.error(err);
            alert("Hata: " + err.message);
        } finally {
            btn.disabled = false;
            btn.innerText = originalText;
        }
    });
</script>
